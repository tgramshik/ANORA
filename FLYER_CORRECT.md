# ✅ Правильная интеграция Flyer Service

## Как ДЕЙСТВИТЕЛЬНО работает Flyer

### Архитектура:
1. **Flyer API** - полностью управляет проверкой подписок
2. **Сообщения с кнопками** - отправляет сам Flyer
3. **Обработка кнопок** - происходит на стороне Flyer
4. **Вебхуки** - Flyer отправляет на `https://giftex.top/api/flyer-webhook`

### Процесс для пользователя:

1. **Пользователь отправляет `/start`**
   - Бот вызывает `flyer.check(user_id)`
   - Если False - Flyer сам отправляет сообщение с кнопками подписки
   - Бот останавливает выполнение

2. **Пользователь подписывается на каналы**

3. **Пользователь нажимает кнопку "Я подписался"**
   - Кнопка обрабатывается Flyer API (не нашим ботом!)
   - Flyer проверяет подписки

4. **Если подписался:**
   - Flyer отправляет вебхук на `https://giftex.top/api/flyer-webhook`
   - Наш вебхук обновляет кэш и отправляет сообщение
   - Пользователь нажимает `/start` снова и получает приветствие

## Текущая конфигурация

### В Flyer Service (уже настроено):
- **Bot ID**: 7944300293
- **Webhook**: https://giftex.top/api/flyer-webhook
- **Type**: sub (подписки)
- **Status**: активен

### В config.py:
```python
USE_FLYER_PARTNER_SYSTEM = True
FLYER_API_KEY = "FL-JmePYE-BgECVA-ELiPvg-lbQsjT"
```

## Важные детали

### Что делает БОТ:
1. Вызывает `flyer.check()` при `/start`
2. Если False - останавливает выполнение
3. Если True - показывает приветствие

### Что делает FLYER:
1. Отправляет сообщение с кнопками подписки
2. Обрабатывает нажатие кнопки "Я подписался"
3. Проверяет подписки
4. Отправляет вебхук если подписан

### Что делает ВЕБХУК:
1. Получает уведомление от Flyer
2. Обновляет кэш (помечает что есть доступ)
3. Отправляет сообщение с просьбой нажать /start

## Проверка работы

### Логи вебхука:
```bash
# В model_selector
grep "FLYER WEBHOOK" /var/log/syslog | tail -20
```

### Логи бота:
```bash
grep FLYER bot.log | tail -20
```

### Тест интеграции:
```bash
python test_flyer_flow.py
```

## Частые проблемы

### "Кнопка не работает"
- Кнопка обрабатывается Flyer, не ботом
- Проверьте что вебхук доступен
- Проверьте логи вебхука

### "Не приходит приветствие после подписки"
- Проверьте что вебхук получает данные
- Проверьте что бот запущен
- Попросите пользователя нажать /start после подписки

### "Два сообщения при /start"
- Это нормально если нет доступа:
  1. Сообщение от Flyer о подписке
  2. После подписки - приветствие

## Отладка

Если вебхук не работает, проверьте:
1. Доступность https://giftex.top/api/flyer-webhook
2. Запущен ли model_selector.py
3. Есть ли ошибки в логах

## Контакты поддержки

- Flyer Service: @flyerservice_support
- Документация: https://flyerservice.io/redoc